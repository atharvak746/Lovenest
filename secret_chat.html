{% extends "base.html" %}

{% block title %}Secret Chat - LoveNest{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-xl shadow-lg overflow-hidden h-[600px] flex flex-col">
        <!-- Chat Header -->
        <div class="gradient-bg p-4">
            <h1 class="text-white text-xl font-bold text-center">
                <i class="fas fa-comments mr-2"></i>
                Secret Chat
            </h1>
            <p class="text-pink-200 text-center text-sm mt-1">Messages automatically disappear for privacy</p>
        </div>
        
        <!-- Messages Container -->
        <div id="messagesContainer" class="flex-1 p-4 overflow-y-auto bg-gray-50">
            <div id="messages" class="space-y-4">
                <!-- Messages will be loaded here -->
            </div>
            <div class="text-center text-gray-500 text-sm py-8" id="noMessages">
                <i class="fas fa-lock text-2xl mb-2 block"></i>
                Start your secret conversation...
            </div>
        </div>
        
        <!-- Message Input -->
        <div class="p-4 border-t bg-white">
            <form id="messageForm" class="space-y-3">
                <div class="flex space-x-2">
                    <input type="text" id="messageInput" 
                           placeholder="Type your secret message..."
                           class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-love-pink focus:border-transparent"
                           maxlength="500">
                    <button type="submit" 
                            class="gradient-bg text-white px-6 py-2 rounded-lg hover:opacity-90 transition-opacity">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                
                <!-- Auto-destruct timer -->
                <div class="flex items-center space-x-4 text-sm">
                    <label class="text-gray-600">Auto-delete after:</label>
                    <select id="destructTimer" class="px-3 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-love-pink">
                        <option value="60">1 minute</option>
                        <option value="300" selected>5 minutes</option>
                        <option value="900">15 minutes</option>
                        <option value="1800">30 minutes</option>
                        <option value="3600">1 hour</option>
                    </select>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let messageInterval;

// Load messages on page load
document.addEventListener('DOMContentLoaded', function() {
    loadMessages();
    // Refresh messages every 2 seconds
    messageInterval = setInterval(loadMessages, 2000);
});

// Clean up interval when leaving page
window.addEventListener('beforeunload', function() {
    if (messageInterval) {
        clearInterval(messageInterval);
    }
});

async function loadMessages() {
    try {
        const response = await fetch('{{ url_for("get_messages") }}');
        const messages = await response.json();
        
        const messagesContainer = document.getElementById('messages');
        const noMessagesDiv = document.getElementById('noMessages');
        
        if (messages.length === 0) {
            messagesContainer.innerHTML = '';
            noMessagesDiv.style.display = 'block';
        } else {
            noMessagesDiv.style.display = 'none';
            
            messagesContainer.innerHTML = messages.map(msg => `
                <div class="flex ${msg.is_mine ? 'justify-end' : 'justify-start'}">
                    <div class="${msg.is_mine ? 'bg-love-pink text-white' : 'bg-white text-gray-800'} 
                                max-w-xs lg:max-w-md px-4 py-2 rounded-lg shadow-sm">
                        <p class="break-words">${escapeHtml(msg.message)}</p>
                        <p class="text-xs mt-1 ${msg.is_mine ? 'text-pink-200' : 'text-gray-500'}">
                            ${msg.created_at}
                        </p>
                    </div>
                </div>
            `).join('');
            
            // Scroll to bottom
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }
    } catch (error) {
        console.error('Error loading messages:', error);
    }
}

// Send message
document.getElementById('messageForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    const duration = parseInt(document.getElementById('destructTimer').value);
    
    if (!message) return;
    
    try {
        const response = await fetch('{{ url_for("send_message") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                duration: duration
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            messageInput.value = '';
            loadMessages(); // Reload messages immediately
        }
    } catch (error) {
        console.error('Error sending message:', error);
    }
});

// Enter key to send message
document.getElementById('messageInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('messageForm').dispatchEvent(new Event('submit'));
    }
});

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
