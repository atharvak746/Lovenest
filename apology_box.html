{% extends "base.html" %}

{% block title %}Apology Box - LoveNest{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">
            <i class="fas fa-heart-broken mr-2 text-love-pink"></i>
            Apology Box
        </h1>
        <p class="text-gray-600">A safe space to apologize and make things right</p>
    </div>
    
    <!-- Send Apology Form -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Send an Apology</h2>
        <form method="POST" action="{{ url_for('send_apology') }}" class="space-y-4">
            <div>
                <label for="message" class="block text-sm font-medium text-gray-700 mb-2">Your Apology Message</label>
                <textarea id="message" name="message" rows="5" required
                          placeholder="Express your sincere apology here. Take your time to explain how you feel and what you want to make right..."
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-love-pink focus:border-transparent resize-none"></textarea>
            </div>
            
            <div class="text-center">
                <button type="submit" 
                        class="gradient-bg text-white px-8 py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">
                    <i class="fas fa-heart mr-2"></i>
                    Send Apology
                </button>
            </div>
        </form>
    </div>
    
    <!-- Apology Messages -->
    {% if apologies %}
    <div class="space-y-6">
        <h2 class="text-2xl font-semibold text-gray-800">Apology Messages</h2>
        
        {% for apology in apologies %}
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="font-semibold text-gray-800">
                            {% if apology[1] == session.user_id %}
                                <i class="fas fa-user mr-2 text-love-pink"></i>
                                From: You
                            {% else %}
                                <i class="fas fa-heart mr-2 text-love-purple"></i>
                                From: Your Partner
                            {% endif %}
                        </h3>
                        <p class="text-sm text-gray-500">{{ apology[3].strftime('%B %d, %Y at %I:%M %p') }}</p>
                    </div>
                    {% if not apology[2] and apology[1] != session.user_id %}
                    <span class="bg-red-100 text-red-800 text-xs font-medium px-3 py-1 rounded-full">
                        New
                    </span>
                    {% endif %}
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <p class="text-gray-700 leading-relaxed">{{ apology[0] }}</p>
                </div>
                
                {% if apology[1] != session.user_id and not apology[2] %}
                <div class="text-center">
                    <button onclick="markAsRead({{ loop.index0 }})" 
                            class="text-love-pink hover:text-love-purple transition-colors text-sm font-medium">
                        <i class="fas fa-check mr-1"></i>
                        Mark as Read
                    </button>
                </div>
                {% elif apology[2] %}
                <div class="text-center text-gray-500 text-sm">
                    <i class="fas fa-check-double mr-1"></i>
                    Read
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="bg-white rounded-xl shadow-lg p-8 text-center">
        <i class="fas fa-dove text-6xl text-gray-300 mb-4"></i>
        <h3 class="text-xl font-semibold text-gray-500 mb-2">All is well in paradise</h3>
        <p class="text-gray-400">No apologies needed right now. Keep loving each other! ❤️</p>
    </div>
    {% endif %}
</div>

<script>
function markAsRead(index) {
    // In a real implementation, you would send an AJAX request to mark the apology as read
    // For now, we'll just hide the "New" badge and "Mark as Read" button
    const apologyCards = document.querySelectorAll('.bg-white.rounded-xl.shadow-lg');
    const card = apologyCards[index + 1]; // +1 because index 0 is the form
    
    if (card) {
        const newBadge = card.querySelector('.bg-red-100');
        const markReadBtn = card.querySelector('button[onclick*="markAsRead"]');
        
        if (newBadge) newBadge.remove();
        if (markReadBtn) {
            markReadBtn.parentElement.innerHTML = `
                <div class="text-center text-gray-500 text-sm">
                    <i class="fas fa-check-double mr-1"></i>
                    Read
                </div>
            `;
        }
    }
}
</script>
{% endblock %}
